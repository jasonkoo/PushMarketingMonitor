/* AvatarUI Dialog | By Rocky | 2013-03-28 */
define(function(require){
	require('avatarui_css/avatarui_dialog.css?20130328');
	$.Dialog=function(j){function t(c,a){$(window).bind("resize."+a,function(){""!=b.position?u(c):(v&&clearTimeout(v),v=setTimeout(function(){if(!0==o||!0==m){if(x(c,!0),!1==b.follow){var a=$(window).width(),d=$(window).height(),a=a/2-c.attr("w")/2+b.offsetX,a=0<a?a:0,d=d/2-c.attr("h")/2+b.offsetY;c.attr({t:0<d?d:0,l:a})}}else r(c)},100))});$(window).bind("scroll."+a,function(){""!=b.position&&u(c)});$(document).bind("keyup."+a,function(b){b=b||window.e;27==b.keyCode&&p(c)});$(".closeDialog").bind("click."+a,function(){p(c)});$(".rePos").bind("click."+a,function(){r($(this).parents(".dialog"))});b.autoClose&&"number"===typeof b.autoClose&&setTimeout(function(){p(c)},1E3*b.autoClose)}function y(c){return $('<div class="dialog" id="'+c+'"><div class="dialogTitle"><div class="dialogTitleH1">'+b.title+'</div><a href="javascript:;" class="dialogClose">X</a>'+(!0==b.max?'<a href="javascript:;" class="dialogMax"></a>':"")+(!0==b.min?'<a href="javascript:;" class="dialogMin"></a>':"")+(!0==b.fold?'<a href="javascript:;" class="dialogFold"></a>':"")+'</div><div class="dialogCon"></div></div>')}function z(c){var b=c.find(".dialogTitleH1").html(),a=c.attr("id"),a=a.substring(a.lastIndexOf("_"));0==$("#DialogMinBar").length&&($(document.body).append('<div id="DialogMinBar" class="dialogMinBar"></div>'),n?$("#DialogMinBar").animate({top:"-=25"},150):$("#DialogMinBar").animate({bottom:"+=25"},150));var d=$('<div id="DialogMinBar'+a+'" class="active"><a href="javascript:;">'+b+'</a><a href="javascript:;" class="dialogMinBarClose">X</a></div>');d.appendTo("#DialogMinBar");d.click(function(){!0==m?(c.show().animate({width:c.attr("w"),height:c.attr("h"),top:c.attr("t"),left:c.attr("l")},150),d.addClass("active"),m=!1):(A(c),m=!0)});d.find(".dialogMinBarClose").click(function(b){b.stopPropagation();p(c)})}function r(c){if(""!=b.position)u(c);else{var a=$(window).scrollTop(),k=$(window).scrollLeft(),d=$(window).width(),e=$(window).height(),f,g;c.css("z-index",parseInt((new Date).getTime()/1E3));void 0==c.attr("resize")?(c.width(b.width),f=b.width):f=c.width();c.show();void 0==c.attr("resize")?""!=b.height?(g=b.height,c.find(".dialogCon").height(g-c.find(".dialogTitle").outerHeight()-22)):g=c.find(".dialogCon").outerHeight()+c.find(".dialogTitle").outerHeight():g=c.height();c.css("height",g);if(!1!=b.follow)d=$(b.follow).offset().left+b.offsetX,e=$(b.follow).offset().top+$(b.follow).outerHeight()+b.offsetY,c.css("position","absolute");else if(""!=b.left?d=b.left:(d=d/2-f/2+b.offsetX,d=0<d?d:0),""!=b.top?e=b.top:(e=e/2-g/2+b.offsetY,e=0<e?e:0),n||!1==b.scroll)d+=k,e+=a,c.css("position","absolute");c.attr({w:f,h:g,t:e,l:d});!0==o?c.animate({left:d,top:e},150):c.css({left:d,top:e})}}function u(c){var a=$(window).scrollTop(),k=$(window).scrollLeft(),d=$(window).width(),e=$(window).height(),f,g,l;c.css("z-index",parseInt((new Date).getTime()/1E3));c.width(b.width);g=b.width;c.show();l=b.height?b.height:c.find(".dialogCon").outerHeight()+c.find(".dialogTitle").outerHeight();c.css("height",l);"rightBottom"==b.position?f=d-g-4+b.offsetX:"leftBottom"==b.position&&(f=0+b.offsetX);d=e-l-2+b.offsetY;n&&(f+=k,d+=a,c.css("position","absolute"));c.css({left:f,top:d})}function x(c,a){var k=$(window).scrollTop(),d=$(window).scrollLeft(),e=$(window).width(),f=$(window).height(),g=0,l=0;if(n||!1!=b.follow||!1==b.scroll)g=k,l=d;!0==a?c.css({width:e-2,height:f-2,top:g,left:l}):c.animate({width:e-2,height:f-2,top:g,left:l},150)}function A(a){var i=$(window).scrollTop(),k=$(window).scrollLeft(),d,e,f=a.attr("id"),f=f.substring(f.lastIndexOf("_"));$("#DialogMinBar").find("div").each(function(){var a=$(this).attr("id"),a=a.substring(a.lastIndexOf("_"));if(a==f)return d=$(this).offset().top,e=$(this).offset().left,$(this).removeClass("active"),!1});n||!1!=b.follow||!1==b.scroll?(i=d,k=e):(i=d-i,k=e-k);a.animate({width:0,height:0,left:k,top:i},300,function(){a.hide()})}function B(){var a=$(document).height();$(document.body).append('<div class="dialogMask" id="DialogMask"></div>');$("#DialogMask").css({position:"absolute",height:a}).show();n&&($("#DialogMask").append('<iframe scrolling="no" frameborder="0" id="DialogIframe" style="width:100%; filter:alpha(opacity=0); -moz-opacity:0; opacity:0;"></iframe>'),$("#DialogIframe").css({height:a}))}function p(a){var i=a.attr("id"),i=i.substring(i.lastIndexOf("_")+1);$(window).unbind("."+i);$(document).unbind("."+i);$(".closeDialog").unbind("."+i);$(".rePos").unbind("."+i);$("#DialogMask").remove();b.closeCallback(a);""!=b.position?a.animate({top:"+="+a.outerHeight()},150,function(){a.remove()}):a.hide();$("#DialogMinBar_"+i).remove();""==$("#DialogMinBar").html()&&(n?$("#DialogMinBar").animate({top:"+=25"},150,function(){$("#DialogMinBar").remove()}):$("#DialogMinBar").animate({bottom:"-=25"},150,function(){$("#DialogMinBar").remove()}))}function E(a,b,k){var d=!1,e,f,g,l,h,j;a.css("cursor","move");a.mousedown(function(m){d=!0;e=m.pageX-parseInt(b.css("left"));f=m.pageY-parseInt(b.css("top"));g=$(window).width();l=$(window).height();h=parseInt(b.outerWidth());j=parseInt(b.outerHeight());document.body.setCapture&&b[0].setCapture();$(document).mousemove(function(a){if(d){var c=a.pageX-e,a=a.pageY-f;!1==k&&(n||(a));b.css({top:a,left:c})}}).mouseup(function(){a.removeClass("dialogTitleDrag");d=!1;document.body.releaseCapture&&b[0].releaseCapture()})})}var b=$.extend({},{width:500,height:"",title:"",contentDom:"",content:{text:"",id:""},offsetX:0,offsetY:0,left:"",top:"",mask:!0,follow:!1,hideTitle:!1,resize:!0,position:"",scroll:!0,max:!1,min:!1,fold:!1,autoClose:!1,initCallback:function(){},closeCallback:function(){}},j),n=$.browser.msie&&"6.0"==$.browser.version,v,o=!1,m=!1,s=!1,j=""!=b.contentDom,a,h,q;j?(a=$(b.contentDom),(h=a.attr("dialog"))?(h=!0,q=a.attr("dialog")):h=!1):(a=$("#Dialog_"+b.content.id),q=b.content.id,h=0<a.length?!0:!1);if(h)j=$("#Dialog_"+q),r(j),b.min&&z(a),b.mask&&B(),t(j,q),b.initCallback(j);else{h=parseInt((new Date).getTime()/1E3);j?($(document.body).append(y("Dialog_"+h)),a=$("#Dialog_"+h),$(b.contentDom).show().attr("dialog",h),$(b.contentDom).appendTo(a.find(".dialogCon"))):($(document.body).append(y("Dialog_"+b.content.id)),a=$("#Dialog_"+b.content.id),a.find(".dialogCon").html("<div>"+b.content.text+"</div>"));b.hideTitle&&a.find(".dialogTitle").remove();r(a);j?t(a,h):t(a,b.content.id);a.find(".dialogClose").bind("click",function(){p(a)});a.bind("mousedown",function(){a.css("z-index",parseInt((new Date).getTime()/1E3))});!0==b.max&&a.find(".dialogMax").click(function(){!1==o?(x(a),$(this).addClass("dialogMaxActive"),a.find(".dialogFold").removeClass("dialogFoldActive").addClass("dialogFoldDisable"),a.find(".dialogCon").show(),a.find(".dialogMin").addClass("dialogMinDisable"),o=!0):(a.animate({width:a.attr("w"),height:a.attr("h"),top:a.attr("t"),left:a.attr("l")},150),$(this).removeClass("dialogMaxActive"),a.find(".dialogFold").removeClass("dialogFoldDisable"),a.find(".dialogMin").removeClass("dialogMinDisable"),o=s=!1)});!0==b.min&&(z(a),a.find(".dialogMin").click(function(){!1==m&&(A(a),m=!0)}));!0==b.fold&&a.find(".dialogFold").click(function(){$(this).hasClass("dialogFoldDisable")||(!1==s?(a.animate({height:a.find(".dialogTitle").outerHeight()},150,function(){a.find(".dialogCon").hide()}),$(this).addClass("dialogFoldActive"),s=!0):(a.animate({height:a.find(".dialogCon").outerHeight()+a.find(".dialogTitle").outerHeight()},150,function(){a.find(".dialogCon").show()}),$(this).removeClass("dialogFoldActive"),s=!1))});if(!0==b.resize){a.append('<div class="dialogResize"></div>');var w=!1,C,D;a.find(".dialogResize").mousedown(function(b){w=!0;C=b.pageX;D=b.pageY;var b=a.find(".dialogCon"),i=a.width(),h=a.height(),d=a.css("left"),d=d.substring(0,d.lastIndexOf("px")),d=a.css("top"),d=d.substring(0,d.lastIndexOf("px"));b.width();b.height();a.attr("resize",!0);document.body.setCapture&&a[0].setCapture();$(document).mousemove(function(b){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty();w&&a.css({height:h+(b.pageY-D),width:i+(b.pageX-C)})}).mouseup(function(){w=!1;document.body.releaseCapture&&a[0].releaseCapture()})})}b.mask&&B();""==b.position&&E(a.find(".dialogTitle"),a,b.follow);b.initCallback("#Dialog_"+q)}};
});